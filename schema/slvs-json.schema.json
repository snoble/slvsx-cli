{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://slvsx.org/schema/slvs-json/v1",
  "title": "SLVS JSON Schema",
  "description": "JSON schema for SolveSpace constraint documents",
  "type": "object",
  "required": ["schema", "units"],
  "properties": {
    "schema": {
      "type": "string",
      "const": "slvs-json/1",
      "description": "Schema version identifier"
    },
    "units": {
      "type": "string",
      "enum": ["mm", "in", "m"],
      "description": "Units for all measurements"
    },
    "parameters": {
      "type": "object",
      "description": "Named parameters that can be referenced in expressions",
      "additionalProperties": {
        "type": "number"
      }
    },
    "entities": {
      "type": "array",
      "description": "Geometric entities (gears, circles, etc.)",
      "items": {
        "$ref": "#/$defs/Entity"
      }
    },
    "constraints": {
      "type": "array", 
      "description": "Constraints between entities",
      "items": {
        "$ref": "#/$defs/Constraint"
      }
    }
  },
  "$defs": {
    "Entity": {
      "type": "object",
      "required": ["type", "id"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["gear", "circle", "point", "line"]
        },
        "id": {
          "type": "string",
          "description": "Unique identifier for this entity"
        }
      },
      "oneOf": [
        {"$ref": "#/$defs/GearEntity"},
        {"$ref": "#/$defs/CircleEntity"},
        {"$ref": "#/$defs/PointEntity"},
        {"$ref": "#/$defs/LineEntity"}
      ]
    },
    "GearEntity": {
      "type": "object",
      "required": ["type", "id", "center", "teeth", "module", "pressure_angle"],
      "properties": {
        "type": {"const": "gear"},
        "id": {"type": "string"},
        "center": {
          "$ref": "#/$defs/Point3D"
        },
        "teeth": {
          "oneOf": [
            {"type": "integer", "minimum": 1},
            {"type": "string", "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*$"}
          ]
        },
        "module": {
          "oneOf": [
            {"type": "number", "minimum": 0},
            {"type": "string", "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*$"}
          ]
        },
        "pressure_angle": {
          "oneOf": [
            {"type": "number", "minimum": 0, "maximum": 90},
            {"type": "string", "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*$"}
          ]
        },
        "phase": {
          "type": "number",
          "description": "Rotational phase in degrees"
        },
        "internal": {
          "type": "boolean",
          "description": "Whether this is an internal gear (ring gear)"
        }
      }
    },
    "CircleEntity": {
      "type": "object",
      "required": ["type", "id", "center", "diameter"],
      "properties": {
        "type": {"const": "circle"},
        "id": {"type": "string"},
        "center": {
          "$ref": "#/$defs/Point3D"
        },
        "diameter": {
          "oneOf": [
            {"type": "number", "minimum": 0},
            {"type": "string"}
          ]
        }
      }
    },
    "PointEntity": {
      "type": "object",
      "required": ["type", "id", "position"],
      "properties": {
        "type": {"const": "point"},
        "id": {"type": "string"},
        "position": {
          "$ref": "#/$defs/Point3D"
        }
      }
    },
    "LineEntity": {
      "type": "object",
      "required": ["type", "id", "start", "end"],
      "properties": {
        "type": {"const": "line"},
        "id": {"type": "string"},
        "start": {
          "$ref": "#/$defs/Point3D"
        },
        "end": {
          "$ref": "#/$defs/Point3D"
        }
      }
    },
    "Point3D": {
      "type": "array",
      "items": {"type": "number"},
      "minItems": 3,
      "maxItems": 3,
      "description": "3D point as [x, y, z]"
    },
    "Constraint": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["mesh", "distance", "angle", "coincident"]
        }
      },
      "oneOf": [
        {"$ref": "#/$defs/MeshConstraint"},
        {"$ref": "#/$defs/DistanceConstraint"},
        {"$ref": "#/$defs/AngleConstraint"},
        {"$ref": "#/$defs/CoincidentConstraint"}
      ]
    },
    "MeshConstraint": {
      "type": "object",
      "required": ["type", "gear1", "gear2"],
      "properties": {
        "type": {"const": "mesh"},
        "gear1": {
          "type": "string",
          "description": "ID of first gear"
        },
        "gear2": {
          "type": "string",
          "description": "ID of second gear"
        }
      }
    },
    "DistanceConstraint": {
      "type": "object",
      "required": ["type", "between", "value"],
      "properties": {
        "type": {"const": "distance"},
        "between": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 2,
          "maxItems": 2,
          "description": "IDs of two entities"
        },
        "value": {
          "oneOf": [
            {"type": "number", "minimum": 0},
            {"type": "string"}
          ]
        }
      }
    },
    "AngleConstraint": {
      "type": "object",
      "required": ["type", "between", "value"],
      "properties": {
        "type": {"const": "angle"},
        "between": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 2,
          "maxItems": 2
        },
        "value": {
          "oneOf": [
            {"type": "number"},
            {"type": "string"}
          ]
        }
      }
    },
    "CoincidentConstraint": {
      "type": "object",
      "required": ["type", "entities"],
      "properties": {
        "type": {"const": "coincident"},
        "entities": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 2
        }
      }
    }
  }
}